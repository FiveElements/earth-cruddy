<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-dropdown/iron-dropdown.html">

<link rel="import" href="../paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../paper-header-panel/paper-header-panel.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-toolbar/paper-toolbar.html">

<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-menu/paper-menu.html">

<link rel="import" href="earth-dropdown-trigger.html">

<link rel="import" href="../paper-item/paper-icon-item.html">

<!--

The `earth-editable-layout` provides layout for edition

@group earth Elements
@element earth-editable-layout
@demo demo/index.html
-->

<dom-module id="earth-editable-layout">

    <style>
        :host {
            display: block;
            height: 100%;
        }

       ul {
           list-style-type: none;
            background-color: var(--paper-menu-background-color, --primary-background-color);
            color: var(--paper-menu-color, --primary-text-color);
        }


    </style>
    <template>


        <paper-header-panel>

            <!-- Header Toolbar -->
            <paper-toolbar>
                <paper-icon-button icon="arrow-back" on-tap="onBack"></paper-icon-button>
                <div class="title">
                    <content select="[bannerTitle]"></content>
                </div>
                <div>
                    <paper-icon-button icon="check" disabled$="[[!status.isDirty]]"
                                       on-tap="_onSave"></paper-icon-button>
                    <earth-dropdown-trigger>
                        <paper-icon-button class="dropdown-trigger" icon="more-vert"></paper-icon-button>
                        <ul class="dropdown-content" tabindex="0">
                            <li>
                                <paper-icon-item on-tap="_onDelete">
                                    <iron-icon icon="delete" item-icon></iron-icon>
                                    Delete
                                </paper-icon-item>
                            </li>
                            <li>
                                <paper-icon-item on-tap="_onSave">
                                    <iron-icon icon="check" item-icon></iron-icon>
                                    Save
                                </paper-icon-item>
                            </li>
                        </ul>
                    </earth-dropdown-trigger>

                </div>
            </paper-toolbar>

            <!-- Main Content -->
            <div class="content fit">
                <content></content>
            </div>
        </paper-header-panel>


    </template>
</dom-module>

<script>
    (function () {
        'use strict';

        Polymer({
            is: 'earth-editable-layout',

            properties: {
                status: {
                    type: Object,
                    notify: true
                }
            },

            listeners: {
                'air-cruddy-element-register': '_registerCruddyElement',
                'air-cruddy-element-unregister': '_unregisterCruddyElement',
                'air-cruddy-status': 'printChange'
            },

//
            printChange: function (e) {
                this.set('status', e.detail);
            },


            // --- Life Cycle
            // --- ---------------------------
            openMoreAction: function () {
                this.$.dropdownMoreAction.open();
            },

            // --- Life Cycle
            // --- ---------------------------
            ready: function () {
                // Holds all the custom elements registered with this form.
                this._cruddyElements = [];
            },

            // --- Status computer
            // --- ---------------------------
            _isSavabled: function (status) {
                return !this.status.isDirty;
            },

            // --- Node Watcher
            // --- ---------------------------
            _registerCruddyElement: function (e) {
                e.target._parentForm = this;
                if (this !== e.target) {
                    // Single
                    this._cruddyElement = e.target;
                    this.set('status', this._cruddyElement.crudStatus);
                    // List
                    this._cruddyElements.push(e.target);
                }
            },

            _unregisterCruddyElement: function (e) {
                var target = e.detail.target;
                if (target) {
                    //
                    // List
                    var index = this._cruddyElements.indexOf(target);
                    if (index > -1) {
                        this._cruddyElements.splice(index, 1);
                    }
                }
            },

            // --- Button
            // --- ---------------------------

            _onSave: function (event) {
                this.save();
            },

            _onDelete: function (event) {
                this.delete();
            },


            // --- Crud Status
            // --- ---------------------------


            // --- Action
            // --- ---------------------------

            _callCruddyFunction: function (funcName) {
                if (this._cruddyElements) {
                    this._cruddyElements.forEach(function (elt) {
                        if (typeof elt[funcName] === 'function') {
                            elt[funcName]();
                        }
                    });
                }
            },


            save: function () {
                this._callCruddyFunction('save');
            },

            delete: function () {
                this._callCruddyFunction('delete');
            }


        });
    })();
</script>
