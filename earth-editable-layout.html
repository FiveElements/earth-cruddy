<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-icons/iron-icons.html">

<link rel="import" href="../paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../paper-header-panel/paper-header-panel.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-toolbar/paper-toolbar.html">

<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">

<!--

The `earth-editable-layout` provides layout for edition

@group earth Elements
@element earth-editable-layout
@demo demo/index.html
-->

<dom-module id="earth-editable-layout">

    <style>
        :host {
            display: block;
            height: 100%;
        }
    </style>
    <template>


        <paper-header-panel>

            <!-- Header Toolbar -->
            <paper-toolbar>
                <paper-icon-button icon="arrow-back" on-tap="onBack"></paper-icon-button>
                <div class="title">
                    <content select="[bannerTitle]"></content>
                </div>
                <div>
                    <paper-icon-button icon="check" disabled$="[[!status.isDirty]]" on-tap="_onSave"></paper-icon-button>
                    <paper-icon-button icon="delete" disabled?="{{!status.isDirty}}"
                                       on-tap="_onDelete"></paper-icon-button>
                    <paper-icon-button icon="more-vert" on-tap="moreAction"></paper-icon-button>
                </div>
            </paper-toolbar>

            <!-- Main Content -->
            <div class="content fit">
                <div>Status From Earth : <span>{{status.isDirty}}</span></div>
                <div>Mode From Earth : <span>{{status.mode}}</span></div>
                <content></content>
            </div>
        </paper-header-panel>


    </template>
</dom-module>

<script>
    (function () {
        'use strict';

        Polymer({
            is: 'earth-editable-layout',

            properties: {
                status: {
                    type: Object,
                    notify: true
                }
            },

            listeners: {
                'air-cruddy-element-register': '_registerCruddyElement',
                'air-cruddy-element-unregister': '_unregisterCruddyElement',
                'air-cruddy-status': 'printChange'
            },

//
            printChange: function (e) {
                console.warn('---- Change crud status ', e.detail);
                this.set('status',e.detail);
            },

            // --- Life Cycle
            // --- ---------------------------
            ready: function () {
                // Holds all the custom elements registered with this form.
                this._cruddyElements = [];
            },

            // --- Status computer
            // --- ---------------------------
            _isSavabled: function (status) {
                return !this.status.isDirty;
            },

            // --- Node Watcher
            // --- ---------------------------
            _registerCruddyElement: function (e) {
                e.target._parentForm = this;
                if (this !== e.target) {
                    // Single
                    this._cruddyElement = e.target;
                    this.set('status', this._cruddyElement.crudStatus);
//                    this.status = this._cruddyElement.crudStatus;
                    console.log('Register cruddy status', this.status);
                    console.log('Register cruddy ', e.target);
                    // List
                    this._cruddyElements.push(e.target);
                }
            },

            _unregisterCruddyElement: function (e) {
                var target = e.detail.target;
                if (target) {
                    //
                    // List
                    var index = this._cruddyElements.indexOf(target);
                    if (index > -1) {
                        this._cruddyElements.splice(index, 1);
                    }
                }
            },

            // --- Button
            // --- ---------------------------

            _onSave: function (event) {
                this.save();
            },

            _onDelete: function (event) {
                this.delete();
            },


            // --- Crud Status
            // --- ---------------------------

            _getCruddyStatusUpdate: function () {

            },


            // --- Action
            // --- ---------------------------

            _callCruddyFunction: function (funcName) {
                if (this._cruddyElements) {
                    this._cruddyElements.forEach(function (elt) {
                        if (typeof elt[funcName] === 'function') {
                            elt[funcName]();
                        }
                    });
                }
            },


            save: function () {
                this._callCruddyFunction('save');
            },

            delete: function () {
                this._callCruddyFunction('delete');
            },


        });
    })();
</script>